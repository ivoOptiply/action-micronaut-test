name: Build Pull Request
on: pull_request

permissions:
  contents: read

jobs:
  build:
    name: Build pull request
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      - name: Get dependencies
        run: |
          echo ${{ github.base_ref }}
          echo origin/${GITHUB_HEAD_REF}

          # Get modified files from git diff
          MODIFIED_FILES=$(git diff --name-only ${{ github.base_ref }}^ origin/${GITHUB_HEAD_REF})
          echo $MODIFIED_FILES

          # Extract unique package names from modified files
          MODIFIED_SUBPROJECTS=$(echo "$MODIFIED_FILES" | awk -F'/' '{print $1}' | sort -u | paste -sd "|" -)
          echo $MODIFIED_SUBPROJECTS

          # Store Gradle dependencies output in a variable
          DEPENDENCIES=$(./gradlew :sink.service:dependencies)
          echo $DEPENDENCIES

          # Check if any modified subproject is present in dependencies using grep
          echo "$DEPENDENCIES" | grep -qE "$MODIFIED_SUBPROJECTS" && depends_on_modified=true || depends_on_modified=false

          # Output the result
          if [ "$depends_on_modified" = true ]; then
              echo "true"
          else
              echo "false"
          fi
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'oracle'
      - name: Test
        run: ./gradlew test --stacktrace --max-workers 1
      - name: Upload build reports
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: build-reports
          path: '**/build/reports/tests/test/*'
